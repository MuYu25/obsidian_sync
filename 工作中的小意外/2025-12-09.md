# 现象
测试服务器`192.168.1.253`没挂，但是出现以下几个问题
- `mysql`连接不上
- `clickhouser`连接不上
- `ssh`都连接不上
# 原因
数据库内存给的过多，应该是超出物理机的内存了。导致触发了操作系统的`OOM`导致直接给`mysql`和 `clickhouse`给kill掉了。
# 解决办法

如果遇到内存溢出导致服务器进不去，只能等对应的程序自己关闭，或者强制重启服务器了。

### 1. OOM Killer 触发时的日志会提供一个**内存统计快照**：
- **`Mem-Total`, `Mem-Free`：** 查看当时的总内存和可用内存。
- **`Swap-Total`, `Swap-Free`：** 查看 $\text{Swap}$ 的使用情况。如果 $\text{Swap}$ 几乎用尽，表明系统压力极大。
- **`Total committed memory`：** 这行显示了当前所有进程**承诺**要使用的内存总量，如果这个值远大于物理内存，即使还没有实际分配，也可能触发 $\text{OOM}$。
### 2.**查看 $\text{MySQL}$ 自己的日志**

虽然 $\text{OOM}$ 是系统杀死的，但 $\text{MySQL}$ 自己的日志（通常在 `/var/log/mysql/error.log` 或 `/var/log/mysql.err`，**但您的列表里没有**，可能位于 `/var/log/syslog` 或其他位置）也值得关注：
- **查找重启记录：** 确认 $\text{mysqld}$ 进程被杀死后，是否尝试**自动重启**，以及重启是否成功。
- **服务启动失败原因：** 如果重启失败，日志可能会记录如**配置错误**、**数据文件损坏**等导致启动失败的原因。
### 3.**确定根本原因**

根据之前对 $\text{OOM}$ 的分析，找到 $\text{mysqld}$ 被杀死的记录后，您需要判断**是哪个配置导致了内存超限**：

- **配置问题：** $\text{MySQL}$ 的 $\text{Buffer Pool}$ ($\text{innodb\_buffer\_pool\_size}$) 设置得太大，超过了服务器的物理内存。
- **突发负载：** 某个时间点大量连接涌入（$\text{max\_connections}$ 过高）或执行了单个**超大、低效的查询**，瞬间耗尽了内存。
# 日志记录
## /var/log/
### dmesg

**核心目标文件**

应该优先查看以下两个文件：
- **`dmesg` / `dmesg.0`：** **内核环形缓冲区**的日志。 $\text{OOM Killer}$ 的活动是最直接记录在这里的。
- **`kern.log`：** 记录所有内核消息，包括 $\text{OOM}$ 事件。
```bash
# 检查当前的dmesg，查找OOM或killed关键词
sudo dmesg | grep -i "oom-killer\|killed process"

# 检查归档的dmesg.0
# 如果OOM发生时间比较早，可能已经被轮转到dmesg.0
sudo zgrep -i "oom-killer\|killed process" dmesg.0
```

**实际内容**

```bash
sudo dmesg | grep -i "oom-killer\|killed process"
[3205518.409581] sshd invoked oom-killer: gfp_mask=0x1100cca(GFP_HIGHUSER_MOVABLE), order=0, oom_score_adj=0
[3205518.411226] Out of memory: Killed process 1812 (mysqld) total-vm:13619944kB, anon-rss:10010488kB, file-rss:0kB, shmem-rss:0kB, UID:999 pgtables:20240kB oom_score_adj:0
```

在`dmesg`中就找到了，所以没有在`dmesg.0`中找
### kern.log

`kern.log` 是内核消息的归档，也可能包含相同的信息。

```bash
# 检查当前的kern.log
sudo grep -i "oom-killer\|mysqld" kern.log

# 检查归档的kern.log文件（使用zgrep查看压缩文件）
sudo zgrep -i "oom-killer\|mysqld" kern.log.1 kern.log.2.gz kern.log.3.gz kern.log.4.gz
```

**实际内容**

```bash
sudo grep -i "oom-killer\|mysqld" kern.log
Dec  9 01:29:47 dev kernel: [3205518.409581] sshd invoked oom-killer: gfp_mask=0x1100cca(GFP_HIGHUSER_MOVABLE), order=0, oom_score_adj=0
Dec  9 01:29:47 dev kernel: [3205518.410435] [   1812]   999  1812  3404986  2502622 20725760        0             0 mysqld
Dec  9 01:29:47 dev kernel: [3205518.410511] [   2048]   999  2048   869064   204895  2334720        0             0 mysqld
Dec  9 01:29:47 dev kernel: [3205518.411140] oom-kill:constraint=CONSTRAINT_NONE,nodemask=(null),cpuset=user.slice,mems_allowed=0,global_oom,task_memcg=/system.slice/docker-6ae7eb2232c88c00d5ea962f662b5288a43a4e845d4029fc8da6d7973e1b7f65.scope,task=mysqld,pid=1812,uid=999
Dec  9 01:29:47 dev kernel: [3205518.411226] Out of memory: Killed process 1812 (mysqld) total-vm:13619944kB, anon-rss:10010488kB, file-rss:0kB, shmem-rss:0kB, UID:999 pgtables:20240kB oom_score_adj:0
Dec  9 01:29:49 dev kernel: [3205520.699971] oom_reaper: reaped process 1812 (mysqld), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB
```

### syslog

在某些系统配置下，内核消息也会被转发到 $\text{syslog}$。

```bash
# 检查当前的syslog
sudo grep -i "oom-killer\|mysqld" syslog

# 检查归档的syslog文件
sudo zgrep -i "oom-killer\|mysqld" syslog.1 syslog.2.gz syslog.3.gz syslog.4.gz
```

**实际内容**

```bash
sudo grep -i "oom-killer\|mysqld" syslog
Dec  9 01:29:47 dev kernel: [3205518.409581] sshd invoked oom-killer: gfp_mask=0x1100cca(GFP_HIGHUSER_MOVABLE), order=0, oom_score_adj=0
Dec  9 01:29:47 dev kernel: [3205518.410435] [   1812]   999  1812  3404986  2502622 20725760        0             0 mysqld
Dec  9 01:29:47 dev kernel: [3205518.410511] [   2048]   999  2048   869064   204895  2334720        0             0 mysqld
Dec  9 01:29:47 dev kernel: [3205518.411140] oom-kill:constraint=CONSTRAINT_NONE,nodemask=(null),cpuset=user.slice,mems_allowed=0,global_oom,task_memcg=/system.slice/docker-6ae7eb2232c88c00d5ea962f662b5288a43a4e845d4029fc8da6d7973e1b7f65.scope,task=mysqld,pid=1812,uid=999
Dec  9 01:29:47 dev kernel: [3205518.411226] Out of memory: Killed process 1812 (mysqld) total-vm:13619944kB, anon-rss:10010488kB, file-rss:0kB, shmem-rss:0kB, UID:999 pgtables:20240kB oom_score_adj:0
Dec  9 01:29:49 dev kernel: [3205520.699971] oom_reaper: reaped process 1812 (mysqld), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB
```

# 总结
总结一下，其实不是我解决的，而且日志我也没细看，但是通过这次经历，学习到了一些经验。